#!/usr/bin/env node
const fs = require('fs');
const os = require('os');
const path = require('path');

const AUTH_TOKEN_ENV = 'UNIFIED_AUTH_TOKEN';
const AUTH_FILE_ENV = 'UNIFIED_AUTH_FILE';
const CODEX_CLI_ENV = 'CODEX_CLI_PATH';

function printHelp() {
  console.log(`Usage: unified <command>

Commands:
  auth login    Pair this computer with the mobile app
  codex         Start a Codex session (requires authentication)

Options:
  --force       Force re-authentication and re-pair the device
  --help        Show help
`);
}

function createPairingToken() {
  const now = Date.now().toString(36);
  const rand = Math.random().toString(36).slice(2, 8);
  return `${now}-${rand}`;
}

function defaultDeviceName() {
  const hostname = os.hostname();
  return hostname ? `${hostname} computer` : 'This computer';
}

function buildPairingLink(token, deviceName, forceReauth) {
  const baseUrl = process.env.UNIFIED_MOBILE_URL || 'http://127.0.0.1:4173/mobile/';
  const url = new URL(baseUrl);
  url.searchParams.set('pairing', token);
  url.searchParams.set('device', deviceName);
  if (forceReauth) {
    url.searchParams.set('force', 'true');
  }
  return url.toString();
}

function renderQrPlaceholder(token) {
  const frame = ['+-----------+', '| ######### |', '| # QR QR # |', '| # QR QR # |', '| ######### |', '+-----------+'];
  return `${frame.join('\n')}\nToken: ${token}`;
}

function resolveAuthFile() {
  if (process.env[AUTH_FILE_ENV]) {
    return process.env[AUTH_FILE_ENV];
  }
  return path.join(os.homedir(), '.unified-auth.json');
}

function readAuthTokenFromFile(filePath) {
  try {
    const raw = fs.readFileSync(filePath, 'utf8');
    const payload = JSON.parse(raw);
    return payload.token || payload.access_token || payload.authToken || null;
  } catch (error) {
    return null;
  }
}

function isAuthenticated() {
  const envToken = process.env[AUTH_TOKEN_ENV];
  if (envToken && envToken.trim()) {
    return true;
  }
  const fileToken = readAuthTokenFromFile(resolveAuthFile());
  return Boolean(fileToken && String(fileToken).trim());
}

function resolveCodexCliPath() {
  const override = process.env[CODEX_CLI_ENV];
  if (override && override.trim()) {
    return override;
  }
  const searchPath = process.env.PATH || '';
  const entries = searchPath.split(path.delimiter).filter(Boolean);
  const extensions = process.platform === 'win32' ? ['.exe', '.cmd', '.bat', ''] : [''];
  for (const entry of entries) {
    for (const ext of extensions) {
      const candidate = path.join(entry, `codex${ext}`);
      if (fs.existsSync(candidate)) {
        return candidate;
      }
    }
  }
  return null;
}

function ensureCodexCliAvailable() {
  const codexPath = resolveCodexCliPath();
  if (!codexPath) {
    console.error('Codex CLI is required. Install it to continue.');
    return false;
  }
  return true;
}

function handleAuthLogin(forceReauth) {
  const token = createPairingToken();
  const deviceName = defaultDeviceName();
  const pairingLink = buildPairingLink(token, deviceName, forceReauth);

  console.log('Pair using mobile QR');
  console.log('Option: Mobile QR pairing');
  if (forceReauth) {
    console.log('Mode: Force re-authentication');
  }
  console.log('QR code:');
  console.log(renderQrPlaceholder(token));
  console.log(`Fallback link: ${pairingLink}`);
  console.log('Status: Awaiting approval in the mobile app.');
  console.log('If rejected, this screen will show: Pairing request rejected.');
}

function createSessionId() {
  const now = Date.now().toString(36);
  const rand = Math.random().toString(36).slice(2, 8);
  return `codex-${now}-${rand}`;
}

function startCodexSession() {
  const sessionId = createSessionId();
  console.log('Codex session started.');
  console.log(`Session: ${sessionId}`);
  console.log('Connected for remote access.');
}

function completeAuthentication() {
  const token = createPairingToken();
  process.env[AUTH_TOKEN_ENV] = token;
  console.log('Authentication approved in the mobile app.');
  console.log('Authentication complete.');
}

function startAuthenticationFlow(forceReauth) {
  console.log('Authentication required. Starting authentication flow.');
  handleAuthLogin(forceReauth);
  completeAuthentication();
}

function handleCodexCommand() {
  if (!isAuthenticated()) {
    startAuthenticationFlow(false);
  }

  if (!isAuthenticated()) {
    console.error('Authentication incomplete. Unable to start Codex session.');
    process.exitCode = 1;
    return;
  }

  if (!ensureCodexCliAvailable()) {
    process.exitCode = 1;
    return;
  }

  startCodexSession();
}

function main() {
  const args = process.argv.slice(2);
  if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
    printHelp();
    return;
  }

  if (args[0] === 'auth' && args[1] === 'login') {
    const forceReauth = args.includes('--force');
    handleAuthLogin(forceReauth);
    return;
  }

  if (args[0] === 'codex') {
    handleCodexCommand();
    return;
  }

  console.error('Unknown command.');
  printHelp();
  process.exitCode = 1;
}

main();
